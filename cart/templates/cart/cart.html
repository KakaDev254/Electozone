{% extends 'base.html' %} {% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'cart/cart.css' %}" />

<section class="py-5">
  <div class="container">
    <h2 class="mb-4">Shopping Cart</h2>

    <!-- Cart Items -->
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Product</th>
            <th scope="col">Name</th>
            <th scope="col">Price</th>
            <th scope="col">Quantity</th>
            <th scope="col">Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr class="cart-item">
            <td>
              <img
                src="{{ item.product.main_image.url }}"
                alt="{{ item.product.name }}"
                class="img-fluid"
                style="max-width: 80px"
              />
            </td>
            <td>{{ item.product.name }}</td>
            <td>Ksh {{ item.product.price }}</td>
            <td>
              <form
                method="post"
                action="{% url 'update_cart' item.id %}"
                class="d-flex align-items-center flex-wrap"
              >
                {% csrf_token %}
                <input
                  type="number"
                  name="quantity"
                  class="form-control form-control-sm me-2 mb-2"
                  value="{{ item.quantity }}"
                  min="1"
                  style="width: 70px"
                />
                <button type="submit" class="btn btn-sm btn-dark mb-2">
                  Update
                </button>
              </form>
            </td>
            <td>Ksh {{ item.get_subtotal }}</td>
            <td>
              <form method="post" action="{% url 'remove_from_cart' item.id %}">
                {% csrf_token %}
                <button
                  type="submit"
                  class="btn btn-sm btn-danger"
                  title="Remove item"
                >
                  <i class="bx bx-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center">Your cart is empty.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Delivery Location Selection -->
    <div class="mt-4">
      <form method="post" action="{% url 'set_delivery_location' %}">
        {% csrf_token %}
        <label for="delivery_location" class="form-label fw-bold">
          Select Delivery Location:
        </label>
        <div
          class="d-flex flex-wrap align-items-center"
          style="max-width: 100%"
        >
          <select
            name="location_id"
            id="delivery_location"
            class="form-select form-select-sm me-2 mb-2"
            style="max-width: 300px"
          >
            <option value="">-- Choose Location --</option>
            {% for location in delivery_locations %}
            <option value="{{ location.id }}">
              {{ location.name }} (Ksh {{ location.fee }})
            </option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-sm btn-warning text-white mb-2">
            Set Delivery
          </button>
        </div>
        {% if delivery_message %}
        <div class="mt-2 text-success fw-bold">{{ delivery_message }}</div>
        {% endif %}
      </form>
    </div>

    <!-- Cart Total -->
    <div class="mt-4 border-top pt-3">
      <p><strong>Base Total:</strong> Ksh {{ base_total }}</p>
      {% if coupon_discount %}
      <p><strong>Coupon Discount:</strong> -Ksh {{ coupon_discount }}</p>
      {% endif %} {% if delivery_fee %}
      <p><strong>Delivery Fee:</strong> Ksh {{ delivery_fee }}</p>
      {% endif %}
      <h4>
        Final Total:
        <span class="text-success">Ksh {{ final_total }}</span>
      </h4>
    </div>

    <!-- Coupon Code Form -->
    <div class="mt-4">
      <form
        method="post"
        action="{% url 'apply_coupon' %}"
        class="d-flex flex-wrap align-items-center"
      >
        {% csrf_token %}
        <input
          type="text"
          name="coupon_code"
          class="form-control form-control-sm me-2 mb-2"
          placeholder="Enter Coupon Code"
          style="max-width: 300px"
        />
        <button type="submit" class="btn btn-sm btn-outline-dark mb-2">
          Apply Coupon
        </button>
      </form>
      {% if discount_message %}
      <div class="mt-2 fw-bold">{{ discount_message }}</div>
      {% endif %}
    </div>

    <!-- Proceed to Checkout -->
    <div class="d-flex justify-content-end mt-4">
      <a href="{% url 'checkout' %}" class="btn btn-sm btn-success px-4 py-2">
        Proceed to Checkout
      </a>
    </div>
  </div>
</section>
{% endblock %}
