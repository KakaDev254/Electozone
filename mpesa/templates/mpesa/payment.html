{% extends 'base.html' %} {% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'mpesa/payment.css' %}" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container">
  <h2>M-Pesa Express Payment</h2>

  <form id="paymentForm">
    {% csrf_token %}
    <div class="form-group">
      <label for="phone">Phone Number (Format: 2547XXXXXXXX)</label>
      <input
        type="text"
        id="phone"
        name="phone"
        placeholder="e.g. 254712345678"
        required
      />
    </div>

    <div class="form-group">
      <label for="amount">Amount (KES)</label>
      <input
        type="number"
        id="amount"
        name="amount"
        placeholder="e.g. 100"
        required
      />
    </div>

    <button type="submit" id="payBtn">Pay Now</button>
    <div id="loadingSpinner" class="hidden">
      <img src="{% static 'images/spinner.gif' %}" alt="Loading" />
      Processing payment...
    </div>
  </form>

  <div id="responseMessage" class="message hidden"></div>
</div>

<script>
  $("#paymentForm").on("submit", function (e) {
    e.preventDefault();

    const phone = $("#phone").val();
    const amount = $("#amount").val();
    const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    // Hide previous messages and show loading spinner
    $("#responseMessage")
      .hide()
      .removeClass("success error loading")
      .addClass("hidden");
    $("#loadingSpinner").removeClass("hidden");

    // Validate input
    if (!phone || !amount) {
      $("#responseMessage")
        .removeClass("hidden")
        .addClass("error")
        .text("Please fill all fields.")
        .show();
      $("#loadingSpinner").addClass("hidden");
      return;
    }

    $.ajax({
      url: "{% url 'stk_push' %}",
      type: "POST",
      data: {
        phone: phone,
        amount: amount,
        csrfmiddlewaretoken: csrfToken,
      },
      success: function (response) {
        // Show response based on result
        if (response.error) {
          $("#responseMessage")
            .removeClass("hidden")
            .addClass("error")
            .text(response.error)
            .show();
        } else if (response.ResponseDescription) {
          $("#responseMessage")
            .removeClass("hidden")
            .addClass("success")
            .text(response.ResponseDescription)
            .show();
          // Start polling for payment status
          pollPaymentStatus(response.CheckoutRequestID);
        } else {
          $("#responseMessage")
            .removeClass("hidden")
            .addClass("success")
            .text("STK Push sent! Check your phone.")
            .show();
          // Start polling for payment status
          pollPaymentStatus(response.CheckoutRequestID);
        }
        $("#loadingSpinner").addClass("hidden");
      },
      error: function (xhr) {
        let msg = "An error occurred.";
        if (xhr.responseJSON && xhr.responseJSON.error) {
          msg = xhr.responseJSON.error;
        }
        $("#responseMessage")
          .removeClass("hidden")
          .addClass("error")
          .text(msg)
          .show();
        $("#loadingSpinner").addClass("hidden");
      },
    });
  });

  function pollPaymentStatus(checkoutRequestID) {
    const interval = setInterval(function () {
      $.ajax({
        url: "{% url 'payment_status' %}",
        type: "GET",
        data: { checkoutRequestID: checkoutRequestID },
        success: function (response) {
          if (response.status === "Completed") {
            $("#responseMessage")
              .removeClass("hidden")
              .addClass("success")
              .text("Payment completed successfully!")
              .show();
            clearInterval(interval); // Stop polling after success
          } else if (response.status === "Failed") {
            $("#responseMessage")
              .removeClass("hidden")
              .addClass("error")
              .text("Payment failed. Please try again.")
              .show();
            clearInterval(interval); // Stop polling after failure
          }
        },
        error: function () {
          $("#responseMessage")
            .removeClass("hidden")
            .addClass("error")
            .text("Error checking payment status.")
            .show();
          clearInterval(interval); // Stop polling if error occurs
        },
      });
    }, 5000); // Poll every 5 seconds
  }
</script>
{% endblock content %}
