{% extends 'base.html' %} {% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'mpesa/payment.css' %}" />

<div class="container">
  <div class="payment-container">
    <h4 class="text-center mb-4" style="color: #5f8670">
      <i class="bx bx-mobile"></i> Pay with M-Pesa
    </h4>
    <form id="mpesaForm">
      {% csrf_token %}
      <div class="mb-3">
        <label for="phone" class="form-label">Safaricom Number</label>
        <input
          type="tel"
          class="form-control"
          id="phoneInput"
          name="phone"
          placeholder="e.g. 0722123456"
          required
        />
      </div>
      <div class="mb-3">
        <label for="amount" class="form-label">Amount</label>
        <input
          type="number"
          class="form-control"
          name="amount"
          value="100"
          required
        />
      </div>
      <button type="submit" class="btn btn-pay w-100">Pay with M-Pesa</button>

      <div id="loader" class="text-center mt-3" style="display: none">
        <i class="bx bx-loader bx-spin"></i> Awaiting customer PIN...
      </div>
      <div id="resultMessage" class="text-center mt-3 fw-bold"></div>
    </form>
  </div>
</div>

<script>
  const phoneInput = document.getElementById("phoneInput");
  phoneInput.addEventListener("input", function () {
    let digits = this.value.replace(/\D/g, "");
    if (!digits.startsWith("254")) {
      digits = "254" + digits.replace(/^0+|^254/, "");
    }
    if (digits.length > 12) {
      digits = digits.slice(0, 12);
    }
    this.value = digits;
  });

  document.getElementById("mpesaForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const loader = document.getElementById("loader");
    const result = document.getElementById("resultMessage");
    loader.style.display = "block";
    result.textContent = "";

    const formData = new FormData(this);

    fetch("{% url 'stk_push' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.ResponseCode === "0") {
          const checkoutID = data.CheckoutRequestID;
          pollPaymentStatus(checkoutID); // Start polling
        } else {
          loader.style.display = "none";
          result.textContent =
            data.errorMessage || "Failed to initiate payment.";
          result.className = "text-danger text-center";
        }
      })
      .catch((error) => {
        loader.style.display = "none";
        result.textContent = "An error occurred. Please try again.";
        result.className = "text-danger text-center";
      });
  });

  function pollPaymentStatus(checkoutID) {
    const loader = document.getElementById("loader");
    const result = document.getElementById("resultMessage");

    let attempts = 0;
    const maxAttempts = 20; // max 20 polling attempts to avoid infinite looping
    const interval = setInterval(() => {
      fetch(`/mpesa/payment-status/?checkout_id=${checkoutID}`)
        .then((res) => res.json())
        .then((data) => {
          // If payment is no longer pending, stop polling and display result
          if (data.status !== "pending") {
            clearInterval(interval); // Stop polling
            loader.style.display = "none"; // Hide loader
            result.textContent = data.message; // Display result message
            result.className = data.success
              ? "text-success text-center"
              : "text-danger text-center"; // Update result style (success or failure)
          }
        })
        .catch((err) => {
          console.log("Polling error:", err);
        });

      attempts++;
      // Timeout condition if no status is received after max attempts
      if (attempts >= maxAttempts) {
        clearInterval(interval); // Stop polling
        loader.style.display = "none"; // Hide loader
        result.textContent = "⌛ Timeout — payment status not received."; // Timeout message
        result.className = "text-danger text-center"; // Timeout error style
      }
    }, 3000); // Poll every 3 seconds
  }
</script>

{% endblock content %}
