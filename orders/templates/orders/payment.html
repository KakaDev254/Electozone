{% extends 'base.html' %} {% block content %}
<div class="container my-5">
  <h2 class="mb-4">Payment for Order #{{ order.id }}</h2>
  <p>Total Amount: <strong>Ksh {{ order.get_total|floatformat:2 }}</strong></p>

  {% if message %}
  <div id="status-message" class="alert alert-info">{{ message }}</div>
  <div id="loader" class="text-center my-3" style="display: none">
    <div class="spinner-border text-primary" role="status"></div>
    <p>Please complete payment on your phone...</p>
  </div>
  {% else %}
  <form method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label for="phone" class="form-label"
        >Phone Number (e.g., 2547XXXXXXXX)</label
      >
      <input
        type="tel"
        class="form-control"
        name="phone"
        id="phone"
        placeholder="2547XXXXXXXX"
        required
      />
    </div>
    <button type="submit" class="btn btn-primary">Pay with M-Pesa</button>
  </form>
  {% endif %}
</div>

{% if message %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById("loader");
    const statusMessage = document.getElementById("status-message");
    const merchantRequestId = "{{ merchant_request_id }}";
    let retries = 0;

    loader.style.display = "block";

    function checkStatus() {
      fetch(`/payments/check-status/${merchantRequestId}/`)
        .then((res) => {
          if (!res.ok) throw new Error("Network error");
          return res.json();
        })
        .then((data) => {
          const result = data.result;
          if (result === "COMPLETED") {
            loader.style.display = "none";
            statusMessage.innerHTML =
              '<div class="alert alert-success">Payment successful! Redirecting...</div>';
            setTimeout(() => {
              window.location.href = "{% url 'payment_success' order.id %}";
            }, 3000);
          } else if (result === "FAILED") {
            loader.style.display = "none";
            statusMessage.innerHTML =
              '<div class="alert alert-danger">Payment failed. Please try again.</div>';
          } else if (retries < 12) {
            retries++;
            setTimeout(checkStatus, 5000); // Retry after 5 seconds
          } else {
            loader.style.display = "none";
            statusMessage.innerHTML = `
              <div class="alert alert-warning">
                Payment timeout. 
                <button onclick="window.location.reload()" class="btn btn-sm btn-outline-primary ms-2">Try Again</button>
              </div>`;
          }
        })
        .catch(() => {
          loader.style.display = "none";
          statusMessage.innerHTML =
            '<div class="alert alert-danger">Error checking payment status.</div>';
        });
    }

    checkStatus();
  });
</script>
{% endif %} {% endblock %}
